image: ubuntu:latest

stages:
  - format
  - build
  - test


format:
  stage: format
  before_script:
    - apt update
    - apt install -y python3 git clang-format
    - git clone https://github.com/Sarcasm/run-clang-format
    - cp run-clang-format/run-clang-format.py run-clang-format.py
    - rm -rf run-clang-format
    - touch .clang-format-ignore
    - echo "JsonParser/json.h" >> .clang-format-ignore
  script:
    - python3 ./run-clang-format.py -r ./
  tags:
    - common
    - cpu

build:
  stage: build
  before_script:
    - apt update
    - apt install -y cmake build-essential libgtest-dev
  script:
    - mkdir build && cd build
    - cmake .. && make
    - cd ..
  artifacts:
    paths:
      - bin/TEST_BANK
      - lib/*
  tags:
    - common
    - cpu

test:
  stage: test
  script:
    - bin/TEST_BANK
  tags:
    - common
    - cpu